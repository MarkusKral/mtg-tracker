<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Dashboard - MTG Tournament</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-primary: #FAF9F6;
            --bg-secondary: #F5F3EF;
            --bg-card: #FFFFFF;
            --text-primary: #2D2A26;
            --text-secondary: #6B6560;
            --text-muted: #9CA3AF;
            --border: #E5E2DC;
            --accent-gold: #B8860B;
            --accent-burgundy: #722F37;
            --success: #166534;
            --danger: #991B1B;
            --winner-glow: rgba(184, 134, 11, 0.3);
            --winner-border: #D4A84B;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1A1A1A;
            --bg-secondary: #242424;
            --bg-card: #2D2D2D;
            --text-primary: #F5F5F5;
            --text-secondary: #A0A0A0;
            --text-muted: #6B6B6B;
            --border: #404040;
            --accent-gold: #D4A84B;
            --accent-burgundy: #C45A5A;
            --success: #22C55E;
            --danger: #EF4444;
            --winner-glow: rgba(212, 168, 75, 0.4);
            --winner-border: #D4A84B;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .font-display { font-family: 'Playfair Display', serif; }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        [data-theme="dark"] .card {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .match-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .match-card:hover {
            box-shadow: 0 12px 32px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .match-card.completed {
            background: var(--bg-secondary);
            opacity: 0.8;
        }
        
        [data-theme="dark"] .match-card {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        [data-theme="dark"] .match-card:hover {
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
        }
        
        .health-bar-bg {
            height: 10px;
            background: var(--bg-secondary);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .health-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 0.6s ease;
        }
        .health-bar.healthy { background: var(--success); }
        .health-bar.warning { background: var(--accent-gold); }
        .health-bar.danger { background: var(--accent-burgundy); }
        
        .color-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 3px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .color-W { background-image: url('assets/avatars/W.svg'); }
        .color-U { background-image: url('assets/avatars/U.svg'); }
        .color-B { background-image: url('assets/avatars/B.svg'); }
        .color-R { background-image: url('assets/avatars/R.svg'); }
        .color-G { background-image: url('assets/avatars/G.svg'); }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.live { background: #16A34A; }
        .status-dot.offline { background: #DC2626; }
        
        .standing-row {
            transition: background 0.2s ease;
        }
        .standing-row:hover {
            background: var(--bg-secondary);
        }
        
        .rank-badge {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }
        .rank-1 { background: #FEF3C7; color: #92400E; }
        .rank-2 { background: #F3F4F6; color: #6B7280; }
        .rank-3 { background: #FED7AA; color: #9A3412; }
        .rank-default { background: var(--bg-secondary); color: var(--text-secondary); }
        
        [data-theme="dark"] .rank-1 { background: #78350F; color: #FDE68A; }
        [data-theme="dark"] .rank-2 { background: #374151; color: #D1D5DB; }
        [data-theme="dark"] .rank-3 { background: #7C2D12; color: #FED7AA; }
        
        .player-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: hidden;
            background: var(--bg-secondary);
            border: 3px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .player-avatar-initial {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 22px;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .theme-toggle:hover {
            border-color: var(--text-secondary);
        }
        
        .pairing-row {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }
        .pairing-row:last-child {
            border-bottom: none;
        }
        
        .health-number {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
            line-height: 1;
        }
        
        /* Winner highlight */
        .player-winner {
            background: linear-gradient(135deg, rgba(184, 134, 11, 0.1) 0%, rgba(212, 168, 75, 0.15) 100%);
            border-radius: 12px;
            padding: 12px;
            margin: -12px;
            position: relative;
        }
        
        .player-winner::before {
            content: 'üëë';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .player-winner .player-avatar {
            border-color: var(--winner-border);
            box-shadow: 0 0 20px var(--winner-glow);
        }
        
        .player-winner .health-number {
            color: var(--accent-gold);
        }
        
        /* Position change arrows */
        .position-change {
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
        }
        .position-up {
            color: var(--success);
        }
        .position-down {
            color: var(--danger);
        }
        
        /* Final Results Podium */
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 2rem;
            padding: 2rem 0;
        }
        
        .podium-place {
            text-align: center;
            transition: transform 0.3s ease;
        }
        .podium-place:hover {
            transform: translateY(-8px);
        }
        
        .podium-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
        }
        
        .podium-1 .podium-avatar {
            width: 100px;
            height: 100px;
            font-size: 40px;
            border: 4px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
        }
        .podium-2 .podium-avatar {
            border: 4px solid #C0C0C0;
            box-shadow: 0 0 20px rgba(192, 192, 192, 0.4);
            background: linear-gradient(135deg, #F3F4F6, #E5E7EB);
        }
        .podium-3 .podium-avatar {
            border: 4px solid #CD7F32;
            box-shadow: 0 0 20px rgba(205, 127, 50, 0.4);
            background: linear-gradient(135deg, #FED7AA, #FDBA74);
        }
        
        .podium-medal {
            font-size: 2.5rem;
            margin: 0.75rem 0;
        }
        
        .podium-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .podium-record {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }
        
        .podium-base {
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .podium-1 .podium-base {
            background: linear-gradient(180deg, #FEF3C7, #FDE68A);
            height: 120px;
            width: 140px;
        }
        .podium-2 .podium-base {
            background: linear-gradient(180deg, #F3F4F6, #D1D5DB);
            height: 80px;
            width: 120px;
        }
        .podium-3 .podium-base {
            background: linear-gradient(180deg, #FED7AA, #FDBA74);
            height: 50px;
            width: 120px;
        }
        
        [data-theme="dark"] .podium-1 .podium-base {
            background: linear-gradient(180deg, #78350F, #92400E);
        }
        [data-theme="dark"] .podium-2 .podium-base {
            background: linear-gradient(180deg, #374151, #4B5563);
        }
        [data-theme="dark"] .podium-3 .podium-base {
            background: linear-gradient(180deg, #7C2D12, #9A3412);
        }
        [data-theme="dark"] .podium-1 .podium-avatar {
            background: linear-gradient(135deg, #78350F, #92400E);
            color: #FDE68A;
        }
        [data-theme="dark"] .podium-2 .podium-avatar {
            background: linear-gradient(135deg, #374151, #4B5563);
            color: #D1D5DB;
        }
        [data-theme="dark"] .podium-3 .podium-avatar {
            background: linear-gradient(135deg, #7C2D12, #9A3412);
            color: #FED7AA;
        }
        
        .podium-rank {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
            opacity: 0.4;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header style="background: var(--bg-card); border-bottom: 1px solid var(--border);">
        <div class="max-w-screen-2xl mx-auto px-8 py-6 flex justify-between items-center">
            <div>
                <h1 class="font-display text-4xl font-bold" id="tournament-name">Tournament</h1>
                <p style="color: var(--text-secondary)" class="text-lg mt-1" id="tournament-info">Loading...</p>
            </div>
            <div class="flex items-center gap-10">
                <div class="text-center">
                    <div class="text-sm uppercase tracking-wider" style="color: var(--text-muted)">Round</div>
                    <div class="text-5xl font-bold font-display" id="current-round">-</div>
                </div>
                <div class="flex items-center gap-3">
                    <span id="ws-status" class="status-dot live"></span>
                    <span class="text-sm" style="color: var(--text-secondary)">Live</span>
                </div>
                <button onclick="toggleTheme()" class="theme-toggle px-4 py-3 rounded-xl text-lg">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content - Live Tournament -->
    <main id="live-view" class="max-w-screen-2xl mx-auto px-8 py-8">
        <div class="mb-10">
            <h2 class="font-display text-2xl font-semibold mb-6">Current Matches</h2>
            <div id="matches-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            <div id="no-matches" class="hidden card text-center py-20">
                <p style="color: var(--text-secondary)" class="text-xl">No active matches</p>
                <p class="text-base mt-2" style="color: var(--text-muted)">Waiting for tournament to start...</p>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h2 class="font-display text-2xl font-semibold mb-6">Next Round</h2>
                <div id="next-round-pairings" class="card p-6">
                    <p style="color: var(--text-muted)" class="text-lg text-center py-8">No upcoming round</p>
                </div>
            </div>
            <div>
                <h2 class="font-display text-2xl font-semibold mb-6">Standings</h2>
                <div class="card overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border)">
                                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider" style="color: var(--text-muted)">#</th>
                                <th class="px-6 py-4 text-left text-sm font-medium uppercase tracking-wider" style="color: var(--text-muted)">Player</th>
                                <th class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider" style="color: var(--text-muted)">Record</th>
                                <th class="px-6 py-4 text-center text-sm font-medium uppercase tracking-wider" style="color: var(--text-muted)">Points</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Final Results View -->
    <main id="final-view" class="hidden max-w-screen-2xl mx-auto px-8 py-8">
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 class="font-display text-4xl font-bold mb-2">Tournament Complete!</h2>
            <p style="color: var(--text-secondary)" class="text-xl" id="final-subtitle">Congratulations to all players</p>
        </div>
        <div class="card p-8 mb-8">
            <div class="podium-container" id="podium"></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h2 class="font-display text-2xl font-semibold mb-6">Tournament Statistics</h2>
                <div class="grid grid-cols-2 gap-4" id="stats-grid"></div>
            </div>
            <div>
                <h2 class="font-display text-2xl font-semibold mb-6">Final Standings</h2>
                <div class="card overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border)">
                                <th class="px-4 py-3 text-left text-sm font-medium uppercase" style="color: var(--text-muted)">#</th>
                                <th class="px-4 py-3 text-left text-sm font-medium uppercase" style="color: var(--text-muted)">Player</th>
                                <th class="px-4 py-3 text-center text-sm font-medium uppercase" style="color: var(--text-muted)">Record</th>
                                <th class="px-4 py-3 text-center text-sm font-medium uppercase" style="color: var(--text-muted)">Pts</th>
                            </tr>
                        </thead>
                        <tbody id="final-standings-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = window.location.origin;
        const WS_URL = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host;
        let ws = null;
        let tournamentId = 1;
        let currentMatchIds = new Set();
        let isFirstLoad = true;
        let currentRoundNum = 0;
        let displayedRoundNum = 0; // The round we're currently showing
        let totalRounds = 0;
        let tournamentStatus = '';
        let roundStartPositions = {};
        let allStandings = [];
        let cachedMatchesData = null; // Cache the current displayed matches

        // Theme
        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        function connectWebSocket() {
            ws = new WebSocket(`${WS_URL}/ws/dashboard`);
            ws.onopen = () => document.getElementById('ws-status').className = 'status-dot live';
            ws.onclose = () => {
                document.getElementById('ws-status').className = 'status-dot offline';
                setTimeout(connectWebSocket, 3000);
            };
            ws.onmessage = (event) => handleWebSocketMessage(JSON.parse(event.data));
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'health_update':
                    updatePlayerHealth(data.match_id, data.player_id, data.new_health);
                    break;
                case 'match_complete':
                    updateMatchStatus(data.match_id, 'completed', data.winner_id);
                    loadStandings();
                    break;
                case 'round_complete':
                    // Don't immediately switch - wait for matches to start
                    loadTournamentInfo();
                    loadNextRoundPairings();
                    break;
            }
        }

        function updatePlayerHealth(matchId, playerId, newHealth) {
            const container = document.querySelector(`[data-match="${matchId}"][data-player="${playerId}"]`);
            if (!container) return;
            const healthBar = container.querySelector('.health-bar');
            const healthText = container.querySelector('.health-text');
            if (healthBar && healthText) {
                healthBar.style.width = Math.max(0, (newHealth / 20) * 100) + '%';
                healthText.textContent = newHealth;
                healthBar.className = 'health-bar ' + getHealthClass(newHealth);
            }
        }

        function updateMatchStatus(matchId, status, winnerId) {
            const matchCard = document.querySelector(`[data-match-card="${matchId}"]`);
            if (matchCard && status === 'completed') {
                matchCard.classList.add('completed');
                const badge = matchCard.querySelector('.status-badge');
                if (badge) {
                    badge.style.background = 'var(--bg-secondary)';
                    badge.style.color = 'var(--text-secondary)';
                    badge.textContent = 'Complete';
                }
                if (winnerId) {
                    const winnerContainer = matchCard.querySelector(`[data-player="${winnerId}"]`);
                    if (winnerContainer) winnerContainer.classList.add('player-winner');
                }
            }
        }

        function getHealthClass(health) {
            if (health > 10) return 'healthy';
            if (health > 5) return 'warning';
            return 'danger';
        }

        async function loadTournamentInfo() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/current`);
                const data = await response.json();

                document.getElementById('tournament-name').textContent = data.name;
                document.getElementById('tournament-info').textContent =
                    `${data.status.charAt(0).toUpperCase() + data.status.slice(1)} ‚Ä¢ ${data.players_count} players`;

                tournamentId = data.tournament_id;
                tournamentStatus = data.status;
                currentRoundNum = data.current_round;
                totalRounds = data.total_rounds;

                // Only update displayed round number when we actually switch
                // The header shows what round we're displaying, not what round the server is on
                
                if (data.status === 'completed' || (data.current_round >= data.total_rounds && await isAllMatchesComplete())) {
                    showFinalResults();
                } else {
                    document.getElementById('live-view').classList.remove('hidden');
                    document.getElementById('final-view').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading tournament info:', error);
            }
        }

        async function isAllMatchesComplete() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${tournamentId}/current-round`);
                const data = await response.json();
                return data.matches && data.matches.every(m => m.status === 'completed');
            } catch {
                return false;
            }
        }

        async function showFinalResults() {
            document.getElementById('live-view').classList.add('hidden');
            document.getElementById('final-view').classList.remove('hidden');

            await loadStandings();
            renderPodium();
            renderFinalStandings();
            await loadAndRenderStats();
        }

        function renderPodium() {
            const podium = document.getElementById('podium');
            const top3 = allStandings.slice(0, 3);
            
            if (top3.length < 3) return;

            const order = [top3[1], top3[0], top3[2]]; // 2nd, 1st, 3rd
            const places = ['podium-2', 'podium-1', 'podium-3'];
            const medals = ['ü•à', 'ü•á', 'ü•â'];
            const ranks = ['2', '1', '3'];

            podium.innerHTML = order.map((player, i) => {
                const initial = player.name.charAt(0).toUpperCase();
                const colorStyle = i === 1 ? 'color: #92400E' : i === 0 ? 'color: #6B7280' : 'color: #9A3412';
                return `
                    <div class="podium-place ${places[i]}">
                        <div class="podium-avatar">
                            <span style="${colorStyle}">${initial}</span>
                        </div>
                        <div class="podium-medal">${medals[i]}</div>
                        <div class="podium-name">${player.name}</div>
                        <div class="podium-record">${player.wins}-${player.losses}</div>
                        <div class="podium-base">
                            <div class="podium-rank">${ranks[i]}</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('final-subtitle').textContent = `üéâ ${top3[0].name} wins the tournament!`;
        }

        function renderFinalStandings() {
            const tbody = document.getElementById('final-standings-body');
            const remaining = allStandings.slice(3);

            tbody.innerHTML = remaining.map((player) => `
                <tr class="standing-row" style="border-bottom: 1px solid var(--border)">
                    <td class="px-4 py-3 font-semibold">${player.rank}</td>
                    <td class="px-4 py-3 font-medium">${player.name}</td>
                    <td class="px-4 py-3 text-center">
                        <span style="color: var(--success)">${player.wins}</span>-<span style="color: var(--danger)">${player.losses}</span>
                    </td>
                    <td class="px-4 py-3 text-center font-semibold">${player.points}</td>
                </tr>
            `).join('');
        }

        async function loadAndRenderStats() {
            const statsGrid = document.getElementById('stats-grid');
            
            try {
                const scheduleRes = await fetch(`${API_URL}/api/tournament/${tournamentId}/schedule`);
                const scheduleData = await scheduleRes.json();
                
                const colorStats = { W: {wins: 0, total: 0}, U: {wins: 0, total: 0}, B: {wins: 0, total: 0}, R: {wins: 0, total: 0}, G: {wins: 0, total: 0} };
                const colorNames = { W: 'White', U: 'Blue', B: 'Black', R: 'Red', G: 'Green' };
                
                allStandings.forEach(player => {
                    (player.colors || []).forEach(c => {
                        if (colorStats[c]) {
                            colorStats[c].total++;
                            colorStats[c].wins += player.wins;
                        }
                    });
                });

                let bestColor = null, bestWinRate = 0;
                Object.entries(colorStats).forEach(([color, stats]) => {
                    if (stats.total > 0) {
                        const totalGames = allStandings.filter(p => (p.colors || []).includes(color))
                            .reduce((sum, p) => sum + p.wins + p.losses, 0);
                        const winRate = totalGames > 0 ? (stats.wins / totalGames) * 100 : 0;
                        if (winRate > bestWinRate) { bestWinRate = winRate; bestColor = color; }
                    }
                });

                let popularColor = null, popularCount = 0;
                Object.entries(colorStats).forEach(([color, stats]) => {
                    if (stats.total > popularCount) { popularCount = stats.total; popularColor = color; }
                });

                let totalMatches = scheduleData.rounds.reduce((sum, r) => sum + r.matches.length, 0);
                const undefeated = allStandings.filter(p => p.losses === 0);

                const stats = [
                    { icon: bestColor ? `<span class="color-icon color-${bestColor}" style="width:40px;height:40px"></span>` : 'üé®', value: bestColor ? colorNames[bestColor] : 'N/A', label: `Best Color (${bestWinRate.toFixed(0)}% win rate)` },
                    { icon: popularColor ? `<span class="color-icon color-${popularColor}" style="width:40px;height:40px"></span>` : 'üìä', value: popularColor ? colorNames[popularColor] : 'N/A', label: `Most Popular (${popularCount} players)` },
                    { icon: '‚öîÔ∏è', value: totalMatches, label: 'Total Matches Played' },
                    { icon: 'üèÖ', value: undefeated.length > 0 ? undefeated.map(p => p.name).join(', ') : 'None', label: 'Undefeated Players' }
                ];

                statsGrid.innerHTML = stats.map(stat => `
                    <div class="card stat-card">
                        <div class="stat-icon">${stat.icon}</div>
                        <div class="stat-value">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadCurrentRound() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${tournamentId}/current-round`);
                const data = await response.json();

                const grid = document.getElementById('matches-grid');
                const noMatches = document.getElementById('no-matches');

                if (!data.matches || data.matches.length === 0) {
                    grid.innerHTML = '';
                    noMatches.classList.remove('hidden');
                    currentMatchIds.clear();
                    cachedMatchesData = null;
                    return;
                }

                noMatches.classList.add('hidden');

                const newMatchIds = new Set(data.matches.map(m => m.match_id));
                
                // Check if new round has matches that have started (in_progress or completed)
                const hasStartedMatches = data.matches.some(m => m.status === 'in_progress' || m.status === 'completed');
                
                // Check if this is a different set of matches (new round)
                const isDifferentMatches = newMatchIds.size !== currentMatchIds.size ||
                    ![...newMatchIds].every(id => currentMatchIds.has(id));

                // If we have cached data and the new round hasn't started yet, keep showing cached data
                if (cachedMatchesData && isDifferentMatches && !hasStartedMatches) {
                    // New round exists but hasn't started - keep showing completed round
                    // Just update health values on cached data if needed
                    return;
                }

                // If this is a new round that HAS started, reset positions and switch
                if (isDifferentMatches && hasStartedMatches) {
                    roundStartPositions = {};
                    displayedRoundNum = data.round_number || currentRoundNum;
                    document.getElementById('current-round').textContent = `${displayedRoundNum}/${totalRounds}`;
                    grid.innerHTML = data.matches.map(match => createMatchCard(match)).join('');
                    currentMatchIds = newMatchIds;
                    cachedMatchesData = data;
                    isFirstLoad = false;
                } else if (isFirstLoad || !isDifferentMatches) {
                    // First load or same round - update normally
                    if (isFirstLoad) {
                        displayedRoundNum = data.round_number || currentRoundNum;
                        document.getElementById('current-round').textContent = `${displayedRoundNum}/${totalRounds}`;
                        grid.innerHTML = data.matches.map(match => createMatchCard(match)).join('');
                        currentMatchIds = newMatchIds;
                        cachedMatchesData = data;
                        isFirstLoad = false;
                    } else {
                        // Same round - just update values
                        data.matches.forEach(match => updateMatchCard(match));
                        cachedMatchesData = data;
                    }
                }

                if (currentRoundNum >= totalRounds && data.matches.every(m => m.status === 'completed')) {
                    setTimeout(() => showFinalResults(), 2000);
                }
            } catch (error) {
                console.error('Error loading current round:', error);
            }
        }

        async function loadNextRoundPairings() {
            const container = document.getElementById('next-round-pairings');
            
            if (displayedRoundNum >= totalRounds) {
                container.innerHTML = `<p style="color: var(--text-muted)" class="text-lg text-center py-8">This is the final round</p>`;
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/tournament/${tournamentId}/schedule`);
                const data = await response.json();
                const nextRound = data.rounds?.find(r => r.round_number === displayedRoundNum + 1);
                
                if (!nextRound) {
                    container.innerHTML = `<p style="color: var(--text-muted)" class="text-lg text-center py-8">No upcoming round</p>`;
                    return;
                }

                container.innerHTML = `
                    <div class="text-sm font-medium uppercase tracking-wider mb-4" style="color: var(--text-muted)">Round ${nextRound.round_number} Pairings</div>
                    ${nextRound.matches.map(match => `
                        <div class="pairing-row text-lg">
                            <div class="flex-1 font-semibold">${match.player1}</div>
                            <div class="px-6" style="color: var(--text-muted)">vs</div>
                            <div class="flex-1 text-right font-semibold">${match.player2}</div>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                console.error('Error loading next round:', error);
            }
        }

        function createMatchCard(match) {
            const isCompleted = match.status === 'completed';
            const statusStyle = isCompleted 
                ? 'background: var(--bg-secondary); color: var(--text-secondary);'
                : 'background: #D1FAE5; color: #059669;';

            return `
                <div class="match-card ${isCompleted ? 'completed' : ''}" data-match-card="${match.match_id}">
                    <div class="px-5 py-4 flex justify-between items-center" style="border-bottom: 1px solid var(--border)">
                        <span class="font-semibold text-base" style="color: var(--text-secondary)">Match ${match.match_id}</span>
                        <span class="status-badge px-3 py-1.5 rounded-lg text-sm font-medium" style="${statusStyle}">${isCompleted ? 'Complete' : 'Live'}</span>
                    </div>
                    <div class="p-5">
                        ${createPlayerDisplay(match.match_id, match.player1, match.winner_id)}
                        <div class="my-4 flex items-center">
                            <div class="flex-1 h-px" style="background: var(--border)"></div>
                            <span class="px-4 text-sm font-semibold" style="color: var(--text-muted)">VS</span>
                            <div class="flex-1 h-px" style="background: var(--border)"></div>
                        </div>
                        ${createPlayerDisplay(match.match_id, match.player2, match.winner_id)}
                    </div>
                </div>
            `;
        }

        function updateMatchCard(match) {
            updatePlayerInCard(match.match_id, match.player1, match.winner_id);
            updatePlayerInCard(match.match_id, match.player2, match.winner_id);
            updateMatchStatus(match.match_id, match.status, match.winner_id);
        }

        function updatePlayerInCard(matchId, player, winnerId) {
            const container = document.querySelector(`[data-match="${matchId}"][data-player="${player.player_id}"]`);
            if (!container) return;
            const health = player.health ?? 20;
            const healthBar = container.querySelector('.health-bar');
            const healthText = container.querySelector('.health-text');
            if (healthBar) {
                healthBar.style.width = Math.max(0, (health / 20) * 100) + '%';
                healthBar.className = 'health-bar ' + getHealthClass(health);
            }
            if (healthText) healthText.textContent = health;
            if (winnerId === player.player_id) container.classList.add('player-winner');
        }

        function createPlayerDisplay(matchId, player, winnerId) {
            const health = player.health ?? 20;
            const healthPercent = Math.max(0, (health / 20) * 100);
            const initial = player.name.charAt(0).toUpperCase();
            const isWinner = winnerId === player.player_id;

            const avatarSrc = player.avatar_url 
                ? (player.avatar_url.startsWith('http') ? player.avatar_url : `${API_URL}${player.avatar_url}`)
                : null;
            const avatarContent = avatarSrc
                ? `<img src="${avatarSrc}" alt="${player.name}" onerror="this.parentElement.innerHTML='<div class=\\'player-avatar-initial\\'>${initial}</div>'">`
                : `<div class="player-avatar-initial">${initial}</div>`;

            return `
                <div class="flex items-center gap-4 ${isWinner ? 'player-winner' : ''}" data-match="${matchId}" data-player="${player.player_id}">
                    <div class="player-avatar">${avatarContent}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-lg truncate">${player.name}</div>
                            <div class="health-number health-text">${health}</div>
                        </div>
                        <div class="health-bar-bg mb-2">
                            <div class="health-bar ${getHealthClass(health)}" style="width: ${healthPercent}%"></div>
                        </div>
                        <div class="flex gap-1">
                            ${(player.colors || []).map(color => `<span class="color-icon color-${color}"></span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadStandings() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${tournamentId}/standings`);
                const data = await response.json();
                allStandings = data.standings;

                const tbody = document.getElementById('standings-body');
                const isFirstStandingsLoad = Object.keys(roundStartPositions).length === 0;
                
                if (isFirstStandingsLoad) {
                    data.standings.forEach((player, index) => {
                        roundStartPositions[player.player_id] = index + 1;
                    });
                }
                
                tbody.innerHTML = data.standings.map((player, index) => {
                    const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-default';
                    const currentPos = index + 1;
                    const startPos = roundStartPositions[player.player_id];
                    
                    let positionChange = '';
                    if (startPos !== undefined && startPos !== currentPos) {
                        const diff = startPos - currentPos;
                        positionChange = diff > 0 
                            ? `<span class="position-change position-up">‚ñ≤${diff}</span>`
                            : `<span class="position-change position-down">‚ñº${Math.abs(diff)}</span>`;
                    }
                    
                    return `
                        <tr class="standing-row">
                            <td class="px-6 py-4"><span class="rank-badge ${rankClass}">${player.rank}</span></td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <span class="font-semibold text-lg">${player.name}</span>
                                    ${positionChange}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span style="color: var(--success)" class="font-semibold text-lg">${player.wins}</span>
                                <span style="color: var(--text-muted)">-</span>
                                <span style="color: var(--danger)" class="font-semibold text-lg">${player.losses}</span>
                            </td>
                            <td class="px-6 py-4 text-center"><span class="font-bold text-lg">${player.points}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading standings:', error);
            }
        }

        function startAutoRefresh() {
            setInterval(() => {
                loadCurrentRound();
                loadStandings();
            }, 2000);
        }

        async function init() {
            await loadTournamentInfo();
            await loadCurrentRound();
            await loadStandings();
            await loadNextRoundPairings();
            connectWebSocket();
            startAutoRefresh();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
