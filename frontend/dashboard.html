<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Dashboard - MTG Tournament</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --accent: #F59E0B;
            --bg-dark: #0F0F1A;
            --bg-card: #1A1A2E;
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --success: #10B981;
            --danger: #EF4444;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            background-image: 
                radial-gradient(ellipse at top left, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(245, 158, 11, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at center, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        .font-cinzel { font-family: 'Cinzel', serif; }
        
        .glass-card {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
        }
        
        .match-card {
            background: linear-gradient(145deg, rgba(26, 26, 46, 0.9) 0%, rgba(15, 15, 26, 0.95) 100%);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 20px;
            transition: border-color 0.4s ease, box-shadow 0.4s ease, transform 0.4s ease, opacity 0.4s ease;
            overflow: hidden;
        }
        .match-card:hover {
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 30px rgba(139, 92, 246, 0.1);
        }
        .match-card.completed {
            border-color: rgba(16, 185, 129, 0.3);
            opacity: 0.85;
        }
        
        .health-bar-bg {
            height: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .health-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
        }
        
        .color-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .color-W { background-image: url('assets/avatars/W.svg'); }
        .color-U { background-image: url('assets/avatars/U.svg'); }
        .color-B { background-image: url('assets/avatars/B.svg'); }
        .color-R { background-image: url('assets/avatars/R.svg'); }
        .color-G { background-image: url('assets/avatars/G.svg'); }
        
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }
        
        .standing-row {
            transition: all 0.3s ease;
        }
        .standing-row:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #E8E8E8, #B8B8B8); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); color: #fff; }
        .rank-default { background: rgba(255,255,255,0.1); }
        
        .vs-divider {
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
            height: 2px;
        }
        
        .live-badge {
            background: linear-gradient(135deg, #10B981, #059669);
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px #10B981, 0 0 10px #10B981; }
            to { box-shadow: 0 0 10px #10B981, 0 0 20px #10B981; }
        }
        
        .header-glow {
            box-shadow: 0 4px 30px rgba(139, 92, 246, 0.2);
        }
        
        .player-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }
        
        .player-avatar-bg {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .health-critical { animation: pulse 0.5s ease-in-out infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="glass-card header-glow mx-4 mt-4 px-6 py-5">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-cinzel text-3xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-amber-400 bg-clip-text text-transparent" id="tournament-name">
                    MTG Tournament
                </h1>
                <p class="text-gray-400 text-sm mt-1" id="tournament-info">Loading...</p>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-center">
                    <div class="text-xs text-gray-500 uppercase tracking-wider">Round</div>
                    <div class="text-3xl font-bold text-purple-400 font-cinzel" id="current-round">-</div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="ws-status" class="w-3 h-3 rounded-full bg-green-500 pulse-ring"></div>
                    <span class="text-xs text-gray-500">LIVE</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Matches Grid -->
            <div class="lg:col-span-2">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-cinzel text-2xl font-bold text-white flex items-center gap-3">
                        <span class="text-3xl">‚öîÔ∏è</span> Current Matches
                    </h2>
                    <span class="live-badge px-3 py-1 rounded-full text-xs font-bold text-white">
                        LIVE
                    </span>
                </div>
                <div id="matches-grid" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- Matches will be inserted here -->
                </div>
                <div id="no-matches" class="hidden glass-card text-center py-16">
                    <div class="text-6xl mb-4">üé¥</div>
                    <p class="text-xl text-gray-400">No active matches</p>
                    <p class="text-sm text-gray-600 mt-2">Waiting for tournament to start...</p>
                </div>
            </div>

            <!-- Standings Sidebar -->
            <div class="lg:col-span-1">
                <h2 class="font-cinzel text-2xl font-bold text-white flex items-center gap-3 mb-6">
                    <span class="text-3xl">üèÜ</span> Standings
                </h2>
                <div class="glass-card overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-800">
                                <th class="px-4 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                <th class="px-4 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-4 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pts</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body" class="divide-y divide-gray-800/50">
                            <!-- Standings will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000';
        let ws = null;
        let tournamentId = 1;
        let currentMatchIds = new Set(); // Track existing matches to avoid re-rendering
        let isFirstLoad = true;

        function connectWebSocket() {
            ws = new WebSocket(`${WS_URL}/ws/dashboard`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('ws-status').className = 'w-3 h-3 rounded-full bg-green-500 pulse-ring';
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('ws-status').className = 'w-3 h-3 rounded-full bg-red-500';
                setTimeout(connectWebSocket, 3000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'health_update':
                    updatePlayerHealth(data.match_id, data.player_id, data.new_health);
                    break;
                case 'match_complete':
                    updateMatchStatus(data.match_id, 'completed');
                    loadStandings();
                    break;
                case 'round_complete':
                    loadTournamentInfo();
                    isFirstLoad = true; // Allow animation for new round
                    loadCurrentRound();
                    loadStandings();
                    break;
            }
        }

        function updatePlayerHealth(matchId, playerId, newHealth) {
            const playerContainer = document.querySelector(`[data-match="${matchId}"][data-player="${playerId}"]`);
            if (!playerContainer) return;
            
            const healthBar = playerContainer.querySelector('.health-bar');
            const healthText = playerContainer.querySelector('.health-text');

            if (healthBar && healthText) {
                const percentage = Math.max(0, (newHealth / 20) * 100);
                healthBar.style.width = percentage + '%';
                healthText.textContent = newHealth;
                healthBar.className = 'health-bar ' + getHealthColor(newHealth);
                
                // Update text color
                if (newHealth <= 5) {
                    healthText.classList.add('text-red-400');
                    healthText.classList.remove('text-white');
                } else {
                    healthText.classList.remove('text-red-400');
                    healthText.classList.add('text-white');
                }
                
                if (newHealth <= 5 && newHealth > 0) {
                    playerContainer.classList.add('health-critical');
                } else {
                    playerContainer.classList.remove('health-critical');
                }
            }
        }

        function updateMatchStatus(matchId, status) {
            const matchCard = document.querySelector(`[data-match-card="${matchId}"]`);
            if (matchCard) {
                if (status === 'completed') {
                    matchCard.classList.add('completed');
                    const badge = matchCard.querySelector('.status-badge');
                    if (badge) {
                        badge.className = 'status-badge px-3 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400';
                        badge.textContent = '‚úì Complete';
                    }
                }
            }
        }

        function getHealthColor(health) {
            if (health > 15) return 'bg-gradient-to-r from-green-500 to-emerald-400';
            if (health > 10) return 'bg-gradient-to-r from-yellow-500 to-amber-400';
            if (health > 5) return 'bg-gradient-to-r from-orange-500 to-red-400';
            return 'bg-gradient-to-r from-red-600 to-red-500';
        }

        async function loadTournamentInfo() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/current`);
                const data = await response.json();

                document.getElementById('tournament-name').textContent = data.name;
                document.getElementById('tournament-info').textContent =
                    `${data.status.charAt(0).toUpperCase() + data.status.slice(1)} ‚Ä¢ ${data.players_count} players`;
                document.getElementById('current-round').textContent =
                    `${data.current_round}/${data.total_rounds}`;

                tournamentId = data.tournament_id;
            } catch (error) {
                console.error('Error loading tournament info:', error);
            }
        }

        async function loadCurrentRound() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${tournamentId}/current-round`);
                const data = await response.json();

                const grid = document.getElementById('matches-grid');
                const noMatches = document.getElementById('no-matches');

                if (!data.matches || data.matches.length === 0) {
                    grid.innerHTML = '';
                    noMatches.classList.remove('hidden');
                    currentMatchIds.clear();
                    return;
                }

                noMatches.classList.add('hidden');

                // Check if we need a full refresh (different matches)
                const newMatchIds = new Set(data.matches.map(m => m.match_id));
                const needsFullRefresh = isFirstLoad || 
                    newMatchIds.size !== currentMatchIds.size ||
                    ![...newMatchIds].every(id => currentMatchIds.has(id));

                if (needsFullRefresh) {
                    // Full render with animation only on first load
                    grid.innerHTML = data.matches.map((match, i) => 
                        createMatchCard(match, isFirstLoad ? i : -1)
                    ).join('');
                    currentMatchIds = newMatchIds;
                    isFirstLoad = false;
                } else {
                    // Update existing cards in place
                    data.matches.forEach(match => {
                        updateMatchCard(match);
                    });
                }
            } catch (error) {
                console.error('Error loading current round:', error);
            }
        }

        function createMatchCard(match, animationIndex) {
            const isCompleted = match.status === 'completed';
            const statusClass = isCompleted ? 'completed' : '';
            const statusBadge = isCompleted 
                ? '<span class="status-badge px-3 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400">‚úì Complete</span>'
                : '<span class="status-badge px-3 py-1 rounded-full text-xs font-medium bg-purple-500/20 text-purple-400">‚ö° In Progress</span>';
            
            const animationStyle = animationIndex >= 0 
                ? `opacity: 0; animation: fadeSlideIn 0.5s ease forwards; animation-delay: ${animationIndex * 0.1}s;` 
                : '';

            return `
                <div class="match-card ${statusClass}" data-match-card="${match.match_id}" style="${animationStyle}">
                    <div class="px-5 py-3 border-b border-gray-800/50 flex justify-between items-center">
                        <span class="font-cinzel font-bold text-gray-400">Match ${match.match_id}</span>
                        ${statusBadge}
                    </div>
                    <div class="p-5">
                        ${createPlayerDisplay(match.match_id, match.player1)}
                        <div class="my-4 flex items-center">
                            <div class="flex-1 vs-divider"></div>
                            <span class="px-4 text-gray-600 font-bold text-sm">VS</span>
                            <div class="flex-1 vs-divider"></div>
                        </div>
                        ${createPlayerDisplay(match.match_id, match.player2)}
                    </div>
                </div>
            `;
        }

        function updateMatchCard(match) {
            // Update player 1
            updatePlayerInCard(match.match_id, match.player1);
            // Update player 2
            updatePlayerInCard(match.match_id, match.player2);
            // Update match status
            updateMatchStatus(match.match_id, match.status);
        }

        function updatePlayerInCard(matchId, player) {
            const playerContainer = document.querySelector(`[data-match="${matchId}"][data-player="${player.player_id}"]`);
            if (!playerContainer) return;

            const health = player.health ?? 20;
            const healthPercent = Math.max(0, (health / 20) * 100);
            const healthColor = getHealthColor(health);

            const healthBar = playerContainer.querySelector('.health-bar');
            const healthText = playerContainer.querySelector('.health-text');

            if (healthBar) {
                healthBar.style.width = healthPercent + '%';
                healthBar.className = 'health-bar ' + healthColor;
            }

            if (healthText) {
                healthText.textContent = health;
                if (health <= 5) {
                    healthText.classList.add('text-red-400');
                    healthText.classList.remove('text-white');
                } else {
                    healthText.classList.remove('text-red-400');
                    healthText.classList.add('text-white');
                }
            }

            if (health <= 5 && health > 0) {
                playerContainer.classList.add('health-critical');
            } else {
                playerContainer.classList.remove('health-critical');
            }
        }

        function createPlayerDisplay(matchId, player) {
            const health = player.health ?? 20;
            const healthPercent = Math.max(0, (health / 20) * 100);
            const healthColor = getHealthColor(health);
            const colors = player.colors || [];
            const playerId = player.player_id;
            const initial = player.name.charAt(0).toUpperCase();
            const avatarUrl = player.avatar_url;

            const avatarContent = avatarUrl 
                ? `<img src="${API_URL}${avatarUrl}" alt="${player.name}" onerror="this.parentElement.innerHTML='<div class=\\'player-avatar-bg\\'>${initial}</div>'">`
                : `<div class="player-avatar-bg">${initial}</div>`;

            return `
                <div class="flex items-center gap-4" data-match="${matchId}" data-player="${playerId}">
                    <div class="player-avatar">
                        ${avatarContent}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-white truncate">${player.name}</div>
                            <div class="text-2xl font-bold health-text ${health <= 5 ? 'text-red-400' : 'text-white'}">${health}</div>
                        </div>
                        <div class="health-bar-bg mb-2">
                            <div class="health-bar ${healthColor}" style="width: ${healthPercent}%"></div>
                        </div>
                        <div class="flex gap-1">
                            ${colors.map(color => `<span class="color-icon color-${color} w-5 h-5" title="${getColorName(color)}"></span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function getColorName(color) {
            const names = { W: 'White', U: 'Blue', B: 'Black', R: 'Red', G: 'Green' };
            return names[color] || color;
        }

        async function loadStandings() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${tournamentId}/standings`);
                const data = await response.json();

                const tbody = document.getElementById('standings-body');
                tbody.innerHTML = data.standings.map((player, index) => {
                    const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-default';
                    
                    return `
                        <tr class="standing-row">
                            <td class="px-4 py-4">
                                <span class="rank-badge ${rankClass}">${player.rank}</span>
                            </td>
                            <td class="px-4 py-4">
                                <div class="font-medium text-white">${player.name}</div>
                                <div class="flex gap-1 mt-1">
                                    ${(player.colors || []).map(color =>
                                        `<span class="color-icon color-${color} w-4 h-4"></span>`
                                    ).join('')}
                                </div>
                            </td>
                            <td class="px-4 py-4 text-center">
                                <span class="text-green-400 font-semibold">${player.wins}</span>
                                <span class="text-gray-600 mx-1">-</span>
                                <span class="text-red-400 font-semibold">${player.losses}</span>
                            </td>
                            <td class="px-4 py-4 text-center">
                                <span class="font-bold text-amber-400">${player.points}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading standings:', error);
            }
        }

        function startAutoRefresh() {
            setInterval(() => {
                loadCurrentRound();
                loadStandings();
            }, 2000);
        }

        // Add the CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeSlideIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);

        async function init() {
            await loadTournamentInfo();
            await loadCurrentRound();
            await loadStandings();
            connectWebSocket();
            startAutoRefresh();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
