<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MTG Tournament</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-primary: #FAF9F6;
            --bg-secondary: #F5F3EF;
            --bg-card: #FFFFFF;
            --text-primary: #2D2A26;
            --text-secondary: #6B6560;
            --text-muted: #9CA3AF;
            --border: #E5E2DC;
            --accent-gold: #B8860B;
            --accent-burgundy: #722F37;
            --success: #166534;
            --danger: #991B1B;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1A1A1A;
            --bg-secondary: #242424;
            --bg-card: #2D2D2D;
            --text-primary: #F5F5F5;
            --text-secondary: #A0A0A0;
            --text-muted: #6B6B6B;
            --border: #404040;
            --accent-gold: #D4A84B;
            --accent-burgundy: #C45A5A;
            --success: #22C55E;
            --danger: #EF4444;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .font-display { font-family: 'Playfair Display', serif; }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        [data-theme="dark"] .card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-primary);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-danger {
            background: rgba(153, 27, 27, 0.1);
            color: var(--accent-burgundy);
            border: 1px solid rgba(153, 27, 27, 0.2);
            transition: all 0.2s ease;
        }
        .btn-danger:hover {
            background: rgba(153, 27, 27, 0.2);
        }
        
        [data-theme="dark"] .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }
        [data-theme="dark"] .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .btn-warning {
            background: rgba(184, 134, 11, 0.1);
            color: var(--accent-gold);
            border: 1px solid rgba(184, 134, 11, 0.2);
        }
        .btn-warning:hover {
            background: rgba(184, 134, 11, 0.2);
        }
        
        .input-field {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .input-field:focus {
            border-color: var(--text-primary);
            outline: none;
        }
        
        .match-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        .match-item:hover {
            background: var(--border);
        }
        
        .stat-box {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-registration { background: #DBEAFE; color: #1D4ED8; }
        .status-in_progress { background: #D1FAE5; color: #059669; }
        .status-completed { background: var(--bg-secondary); color: var(--text-secondary); }
        
        [data-theme="dark"] .status-registration { background: #1E3A5F; color: #60A5FA; }
        [data-theme="dark"] .status-in_progress { background: #14532D; color: #4ADE80; }
        
        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .theme-toggle:hover {
            border-color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
        <button onclick="toggleTheme()" class="theme-toggle fixed top-4 right-4 px-3 py-2 rounded-lg text-sm">
            <span id="theme-icon">ðŸŒ™</span>
        </button>
        
        <div class="max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="font-display text-4xl font-bold mb-2">Administration</h1>
                <p style="color: var(--text-secondary)">Tournament Management</p>
            </div>
            
            <div class="card p-8">
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">Password</label>
                    <input type="password" id="admin-password"
                           class="input-field w-full px-4 py-3 rounded-lg text-lg"
                           placeholder="Enter admin password"
                           onkeypress="if(event.key === 'Enter') adminLogin()">
                </div>
                <button onclick="adminLogin()"
                        class="btn-primary w-full font-semibold py-3 rounded-lg">
                    Login
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden">
        <header style="background: var(--bg-card); border-bottom: 1px solid var(--border);" class="px-6 py-4">
            <div class="max-w-5xl mx-auto flex justify-between items-center">
                <div>
                    <h1 class="font-display text-xl font-bold">Tournament Admin</h1>
                </div>
                <div class="flex gap-3">
                    <button onclick="toggleTheme()" class="theme-toggle px-3 py-2 rounded-lg text-sm">
                        <span id="theme-icon-header">ðŸŒ™</span>
                    </button>
                    <button onclick="logout()" class="text-sm" style="color: var(--text-muted)">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-5xl mx-auto px-6 py-8">
            <!-- Create Tournament -->
            <div class="card p-6 mb-6">
                <h2 class="font-display text-lg font-semibold mb-5">Create New Tournament</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
                    <div>
                        <label class="block text-sm mb-2" style="color: var(--text-secondary)">Tournament Name</label>
                        <input type="text" id="tournament-name"
                               class="input-field w-full px-4 py-2.5 rounded-lg"
                               placeholder="Friday Night Draft">
                    </div>
                    <div>
                        <label class="block text-sm mb-2" style="color: var(--text-secondary)">Max Players</label>
                        <input type="number" id="max-players" value="8" min="2" max="20"
                               class="input-field w-full px-4 py-2.5 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm mb-2" style="color: var(--text-secondary)">Starting Life</label>
                        <input type="number" id="starting-life" value="20" min="1"
                               class="input-field w-full px-4 py-2.5 rounded-lg">
                    </div>
                </div>
                <button onclick="createTournament()"
                        class="btn-primary font-medium px-6 py-2.5 rounded-lg">
                    Create Tournament
                </button>
            </div>

            <!-- Current Tournament -->
            <div id="tournament-section" class="hidden">
                <!-- Tournament Info -->
                <div class="card p-6 mb-6">
                    <div class="flex justify-between items-start mb-5">
                        <h2 class="font-display text-lg font-semibold">Current Tournament</h2>
                        <button onclick="deleteTournament()" 
                                class="btn-danger px-3 py-1.5 rounded-lg text-sm font-medium">
                            Delete
                        </button>
                    </div>
                    
                    <div id="tournament-info" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
                        <!-- Info will be populated -->
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button id="generate-schedule-btn" onclick="generateSchedule()"
                                class="btn-primary font-medium px-5 py-2.5 rounded-lg">
                            Generate Schedule
                        </button>
                        <button id="next-round-btn" onclick="nextRound()" class="hidden
                                btn-warning font-medium px-5 py-2.5 rounded-lg">
                            Advance Round
                        </button>
                    </div>
                </div>

                <!-- Players List -->
                <div class="card p-6 mb-6">
                    <h2 class="font-display text-lg font-semibold mb-4">Registered Players</h2>
                    <div id="players-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                        <!-- Players will be populated -->
                    </div>
                </div>

                <!-- Current Matches -->
                <div class="card p-6 mb-6">
                    <h2 class="font-display text-lg font-semibold mb-4">Current Matches</h2>
                    <div id="admin-matches" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Matches will be populated -->
                    </div>
                </div>

                <!-- Tournament History -->
                <div class="card p-6">
                    <h2 class="font-display text-lg font-semibold mb-4">All Tournaments</h2>
                    <div id="tournament-history" class="space-y-2">
                        <!-- Tournament history will be populated -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = window.location.origin;
        let adminToken = null;
        let currentTournament = null;

        // Theme
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcons(newTheme);
        }
        
        function updateThemeIcons(theme) {
            const icon = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            document.getElementById('theme-icon').textContent = icon;
            const headerIcon = document.getElementById('theme-icon-header');
            if (headerIcon) headerIcon.textContent = icon;
        }
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcons(savedTheme);

        async function adminLogin() {
            const password = document.getElementById('admin-password').value;

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (!response.ok) {
                    alert('Invalid password');
                    return;
                }

                const data = await response.json();
                adminToken = data.token;
                localStorage.setItem('adminToken', adminToken);

                showAdminPanel();
            } catch (error) {
                console.error('Error logging in:', error);
                alert('Error logging in');
            }
        }

        function showAdminPanel() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadCurrentTournament();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        async function createTournament() {
            const name = document.getElementById('tournament-name').value.trim();
            const maxPlayers = parseInt(document.getElementById('max-players').value);
            const startingLife = parseInt(document.getElementById('starting-life').value);

            if (!name) {
                alert('Please enter a tournament name');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/tournament`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        name,
                        max_players: maxPlayers,
                        starting_life: startingLife
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to create tournament');
                }

                loadCurrentTournament();
            } catch (error) {
                console.error('Error creating tournament:', error);
                alert('Error creating tournament: ' + error.message);
            }
        }

        async function loadCurrentTournament() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/current`);
                const data = await response.json();

                currentTournament = data;
                document.getElementById('tournament-section').classList.remove('hidden');

                const statusClass = `status-${data.status}`;
                document.getElementById('tournament-info').innerHTML = `
                    <div class="stat-box">
                        <div class="text-xs uppercase tracking-wider mb-1" style="color: var(--text-muted)">Name</div>
                        <div class="font-semibold">${data.name}</div>
                    </div>
                    <div class="stat-box">
                        <div class="text-xs uppercase tracking-wider mb-1" style="color: var(--text-muted)">Status</div>
                        <div><span class="status-badge ${statusClass}">${data.status}</span></div>
                    </div>
                    <div class="stat-box">
                        <div class="text-xs uppercase tracking-wider mb-1" style="color: var(--text-muted)">Players</div>
                        <div class="font-semibold">${data.players_count}</div>
                    </div>
                    <div class="stat-box">
                        <div class="text-xs uppercase tracking-wider mb-1" style="color: var(--text-muted)">Round</div>
                        <div class="font-semibold">${data.current_round}/${data.total_rounds || '?'}</div>
                    </div>
                `;

                const generateBtn = document.getElementById('generate-schedule-btn');
                const nextRoundBtn = document.getElementById('next-round-btn');

                if (data.status === 'registration') {
                    generateBtn.classList.remove('hidden');
                    nextRoundBtn.classList.add('hidden');
                } else {
                    generateBtn.classList.add('hidden');
                    nextRoundBtn.classList.remove('hidden');
                }

                loadPlayers();
                loadCurrentMatches();
                loadTournamentHistory();
            } catch (error) {
                console.error('Error loading tournament:', error);
            }
        }

        async function loadPlayers() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${currentTournament.tournament_id}/standings`);
                const data = await response.json();

                const playersDiv = document.getElementById('players-list');
                if (data.standings.length === 0) {
                    playersDiv.innerHTML = `<p style="color: var(--text-muted)" class="col-span-full text-center py-4">No players registered yet</p>`;
                    return;
                }
                
                playersDiv.innerHTML = data.standings.map(p => `
                    <div class="match-item px-3 py-2 flex justify-between items-center">
                        <span class="font-medium">${p.name}</span>
                        <span class="text-sm" style="color: var(--text-secondary)">
                            <span style="color: var(--success)">${p.wins}</span>-<span style="color: var(--danger)">${p.losses}</span>
                        </span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        async function loadCurrentMatches() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${currentTournament.tournament_id}/current-round`);
                const data = await response.json();

                const matchesDiv = document.getElementById('admin-matches');

                if (!data.matches || data.matches.length === 0) {
                    matchesDiv.innerHTML = `<p style="color: var(--text-muted)" class="col-span-full text-center py-4">No active matches</p>`;
                    return;
                }

                matchesDiv.innerHTML = data.matches.map(m => `
                    <div class="match-item p-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm" style="color: var(--text-secondary)">Match ${m.match_id}</span>
                            <span class="status-badge ${m.status === 'completed' ? 'status-completed' : 'status-in_progress'}">
                                ${m.status}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex-1">
                                <div class="font-medium">${m.player1.name}</div>
                                <div class="text-lg font-bold" style="color: ${(m.player1.health ?? 20) <= 5 ? 'var(--danger)' : 'inherit'}">${m.player1.health ?? 20}</div>
                            </div>
                            <div class="px-3 text-xs" style="color: var(--text-muted)">VS</div>
                            <div class="flex-1 text-right">
                                <div class="font-medium">${m.player2.name}</div>
                                <div class="text-lg font-bold" style="color: ${(m.player2.health ?? 20) <= 5 ? 'var(--danger)' : 'inherit'}">${m.player2.health ?? 20}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading matches:', error);
            }
        }

        async function loadTournamentHistory() {
            try {
                const response = await fetch(`${API_URL}/api/admin/tournaments/history`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                const historyDiv = document.getElementById('tournament-history');
                
                if (!data.tournaments || data.tournaments.length === 0) {
                    historyDiv.innerHTML = `<p style="color: var(--text-muted)" class="text-center py-4">No tournaments yet</p>`;
                    return;
                }

                historyDiv.innerHTML = data.tournaments.map(t => `
                    <div class="match-item flex justify-between items-center px-4 py-3">
                        <div>
                            <div class="font-medium">${t.name}</div>
                            <div class="text-sm" style="color: var(--text-secondary)">
                                <span class="status-badge status-${t.status}">${t.status}</span>
                                <span class="ml-2">${t.players_count} players</span>
                            </div>
                        </div>
                        <button onclick="deleteSpecificTournament(${t.id}, '${t.name.replace(/'/g, "\\'")}')"
                                class="btn-danger px-3 py-1.5 rounded-lg text-sm">
                            Delete
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading tournament history:', error);
            }
        }

        async function generateSchedule() {
            if (!confirm('Generate schedule? Players will no longer be able to join.')) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}/generate-schedule`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to generate schedule');

                loadCurrentTournament();
            } catch (error) {
                console.error('Error generating schedule:', error);
                alert('Error generating schedule');
            }
        }

        async function nextRound() {
            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}/next-round`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to advance round');

                loadCurrentTournament();
            } catch (error) {
                console.error('Error advancing round:', error);
                alert('Error advancing round');
            }
        }

        async function deleteTournament() {
            if (!currentTournament) return;

            if (!confirm(`Delete tournament "${currentTournament.name}"?`)) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to delete');

                currentTournament = null;
                document.getElementById('tournament-section').classList.add('hidden');
                loadCurrentTournament();
            } catch (error) {
                console.error('Error deleting tournament:', error);
                alert('Error deleting tournament');
            }
        }

        async function deleteSpecificTournament(tournamentId, tournamentName) {
            if (!confirm(`Delete "${tournamentName}"?`)) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${tournamentId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to delete');

                if (currentTournament && currentTournament.tournament_id === tournamentId) {
                    currentTournament = null;
                    document.getElementById('tournament-section').classList.add('hidden');
                }
                
                loadTournamentHistory();
                loadCurrentTournament();
            } catch (error) {
                console.error('Error deleting tournament:', error);
                alert('Error deleting tournament');
            }
        }

        setInterval(() => {
            if (!document.getElementById('admin-panel').classList.contains('hidden') && currentTournament) {
                loadCurrentTournament();
            }
        }, 5000);

        window.onload = () => {
            const token = localStorage.getItem('adminToken');
            if (token) {
                adminToken = token;
                showAdminPanel();
            }
        };
    </script>
</body>
</html>
