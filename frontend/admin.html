<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MTG Tournament</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --accent: #F59E0B;
            --bg-dark: #0F0F1A;
            --bg-card: #1A1A2E;
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --success: #10B981;
            --danger: #EF4444;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            background-image: 
                radial-gradient(ellipse at top right, rgba(239, 68, 68, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom left, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        .font-cinzel { font-family: 'Cinzel', serif; }
        
        .glass-card {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
        }
        
        .glow-border {
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.5);
        }
        
        .input-modern {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-modern:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
            outline: none;
        }
        
        .match-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .match-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(26, 26, 46, 0.9) 0%, rgba(15, 15, 26, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.4s ease forwards;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-registration { background: rgba(59, 130, 246, 0.2); color: #60A5FA; }
        .status-in_progress { background: rgba(16, 185, 129, 0.2); color: #34D399; }
        .status-completed { background: rgba(107, 114, 128, 0.2); color: #9CA3AF; }
        
        .tournament-history-item {
            transition: all 0.3s ease;
        }
        .tournament-history-item:hover {
            background: rgba(139, 92, 246, 0.1);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
        <div class="max-w-md w-full animate-slide-in">
            <div class="text-center mb-8">
                <h1 class="font-cinzel text-5xl font-bold bg-gradient-to-r from-red-400 via-purple-400 to-amber-400 bg-clip-text text-transparent mb-2">
                    Admin Panel
                </h1>
                <p class="text-gray-400">Tournament Management</p>
            </div>
            
            <div class="glass-card glow-border p-8">
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-300">Admin Password</label>
                    <input type="password" id="admin-password"
                           class="input-modern w-full px-4 py-4 rounded-xl text-white text-lg"
                           placeholder="Enter password"
                           onkeypress="if(event.key === 'Enter') adminLogin()">
                </div>
                <button onclick="adminLogin()"
                        class="btn-primary w-full text-white font-bold py-4 rounded-xl text-lg">
                    üîê Login
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden">
        <header class="glass-card mx-4 mt-4 px-6 py-5">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="font-cinzel text-2xl font-bold text-white">üéÆ Tournament Control</h1>
                    <p class="text-gray-400 text-sm mt-1">Manage your MTG tournaments</p>
                </div>
                <button onclick="logout()" class="btn-danger text-white px-5 py-2 rounded-xl font-medium">
                    Logout
                </button>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-4 py-8">
            <!-- Create Tournament -->
            <div class="glass-card p-6 mb-6 animate-slide-in">
                <h2 class="font-cinzel text-xl font-bold mb-6 flex items-center gap-3">
                    <span class="text-2xl">‚ú®</span> Create New Tournament
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                    <div>
                        <label class="block text-sm mb-2 text-gray-400">Tournament Name</label>
                        <input type="text" id="tournament-name"
                               class="input-modern w-full px-4 py-3 rounded-xl text-white"
                               placeholder="Friday Night Draft">
                    </div>
                    <div>
                        <label class="block text-sm mb-2 text-gray-400">Draft Type</label>
                        <input type="text" id="draft-type"
                               class="input-modern w-full px-4 py-3 rounded-xl text-white"
                               placeholder="Booster Draft">
                    </div>
                    <div>
                        <label class="block text-sm mb-2 text-gray-400">Max Players</label>
                        <input type="number" id="max-players" value="8" min="2" max="20"
                               class="input-modern w-full px-4 py-3 rounded-xl text-white">
                    </div>
                    <div>
                        <label class="block text-sm mb-2 text-gray-400">Starting Life</label>
                        <input type="number" id="starting-life" value="20" min="1"
                               class="input-modern w-full px-4 py-3 rounded-xl text-white">
                    </div>
                </div>
                <button onclick="createTournament()"
                        class="btn-success text-white font-bold px-8 py-3 rounded-xl">
                    üöÄ Create Tournament
                </button>
            </div>

            <!-- Current Tournament -->
            <div id="tournament-section" class="hidden">
                <!-- Tournament Info -->
                <div class="glass-card p-6 mb-6 animate-slide-in">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="font-cinzel text-xl font-bold flex items-center gap-3">
                                <span class="text-2xl">üèüÔ∏è</span> Current Tournament
                            </h2>
                        </div>
                        <button onclick="deleteTournament()" 
                                class="btn-danger text-white px-4 py-2 rounded-xl text-sm font-medium">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                    
                    <div id="tournament-info" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <!-- Info will be populated -->
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button id="generate-schedule-btn" onclick="generateSchedule()"
                                class="btn-primary text-white font-bold px-6 py-3 rounded-xl">
                            üìã Generate Schedule
                        </button>
                        <button id="next-round-btn" onclick="nextRound()" class="hidden
                                btn-warning text-white font-bold px-6 py-3 rounded-xl">
                            ‚è≠Ô∏è Next Round
                        </button>
                    </div>
                </div>

                <!-- Players List -->
                <div class="glass-card p-6 mb-6">
                    <h2 class="font-cinzel text-xl font-bold mb-4 flex items-center gap-3">
                        <span class="text-2xl">üë•</span> Registered Players
                    </h2>
                    <div id="players-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <!-- Players will be populated -->
                    </div>
                </div>

                <!-- Current Matches -->
                <div class="glass-card p-6 mb-6">
                    <h2 class="font-cinzel text-xl font-bold mb-4 flex items-center gap-3">
                        <span class="text-2xl">‚öîÔ∏è</span> Current Matches
                    </h2>
                    <div id="admin-matches" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Matches will be populated -->
                    </div>
                </div>

                <!-- Tournament History -->
                <div class="glass-card p-6">
                    <h2 class="font-cinzel text-xl font-bold mb-4 flex items-center gap-3">
                        <span class="text-2xl">üìú</span> All Tournaments
                    </h2>
                    <div id="tournament-history" class="space-y-2">
                        <!-- Tournament history will be populated -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let adminToken = null;
        let currentTournament = null;

        async function adminLogin() {
            const password = document.getElementById('admin-password').value;

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (!response.ok) {
                    alert('Invalid password');
                    return;
                }

                const data = await response.json();
                adminToken = data.token;
                localStorage.setItem('adminToken', adminToken);

                showAdminPanel();
            } catch (error) {
                console.error('Error logging in:', error);
                alert('Error logging in');
            }
        }

        function showAdminPanel() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadCurrentTournament();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        async function createTournament() {
            const name = document.getElementById('tournament-name').value.trim();
            const draftType = document.getElementById('draft-type').value.trim();
            const maxPlayers = parseInt(document.getElementById('max-players').value);
            const startingLife = parseInt(document.getElementById('starting-life').value);

            if (!name) {
                alert('Please enter a tournament name');
                return;
            }
            if (!draftType) {
                alert('Please enter a draft type');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/tournament`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        name,
                        draft_type: draftType,
                        tournament_type: "Round Robin",
                        max_players: maxPlayers,
                        match_format: "Best of 1",
                        starting_life: startingLife
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to create tournament');
                }

                alert('Tournament created successfully!');
                loadCurrentTournament();
            } catch (error) {
                console.error('Error creating tournament:', error);
                alert('Error creating tournament: ' + error.message);
            }
        }

        async function loadCurrentTournament() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/current`);
                const data = await response.json();

                currentTournament = data;
                document.getElementById('tournament-section').classList.remove('hidden');

                const statusClass = `status-${data.status}`;
                document.getElementById('tournament-info').innerHTML = `
                    <div class="stat-card rounded-xl p-4">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Name</div>
                        <div class="font-bold text-lg">${data.name}</div>
                    </div>
                    <div class="stat-card rounded-xl p-4">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Status</div>
                        <div><span class="status-badge ${statusClass}">${data.status}</span></div>
                    </div>
                    <div class="stat-card rounded-xl p-4">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Players</div>
                        <div class="font-bold text-lg text-purple-400">${data.players_count}</div>
                    </div>
                    <div class="stat-card rounded-xl p-4">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Round</div>
                        <div class="font-bold text-lg text-amber-400">${data.current_round}/${data.total_rounds || '?'}</div>
                    </div>
                `;

                const generateBtn = document.getElementById('generate-schedule-btn');
                const nextRoundBtn = document.getElementById('next-round-btn');

                if (data.status === 'registration') {
                    generateBtn.classList.remove('hidden');
                    nextRoundBtn.classList.add('hidden');
                } else {
                    generateBtn.classList.add('hidden');
                    nextRoundBtn.classList.remove('hidden');
                }

                loadPlayers();
                loadCurrentMatches();
                loadTournamentHistory();
            } catch (error) {
                console.error('Error loading tournament:', error);
            }
        }

        async function loadPlayers() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${currentTournament.tournament_id}/standings`);
                const data = await response.json();

                const playersDiv = document.getElementById('players-list');
                if (data.standings.length === 0) {
                    playersDiv.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">No players registered yet</p>';
                    return;
                }
                
                playersDiv.innerHTML = data.standings.map(p => `
                    <div class="match-card px-4 py-3 flex justify-between items-center">
                        <span class="font-medium">${p.name}</span>
                        <span class="text-sm">
                            <span class="text-green-400">${p.wins}</span>
                            <span class="text-gray-600">-</span>
                            <span class="text-red-400">${p.losses}</span>
                        </span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        async function loadCurrentMatches() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${currentTournament.tournament_id}/current-round`);
                const data = await response.json();

                const matchesDiv = document.getElementById('admin-matches');

                if (!data.matches || data.matches.length === 0) {
                    matchesDiv.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">No active matches</p>';
                    return;
                }

                matchesDiv.innerHTML = data.matches.map(m => `
                    <div class="match-card p-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-gray-400">Match ${m.match_id}</span>
                            <span class="status-badge ${m.status === 'completed' ? 'status-completed' : 'status-in_progress'}">
                                ${m.status}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex-1">
                                <div class="font-medium">${m.player1.name}</div>
                                <div class="text-2xl font-bold ${(m.player1.health ?? 20) <= 5 ? 'text-red-400' : 'text-purple-400'}">${m.player1.health ?? 20}</div>
                            </div>
                            <div class="px-4 text-gray-600 font-bold">VS</div>
                            <div class="flex-1 text-right">
                                <div class="font-medium">${m.player2.name}</div>
                                <div class="text-2xl font-bold ${(m.player2.health ?? 20) <= 5 ? 'text-red-400' : 'text-purple-400'}">${m.player2.health ?? 20}</div>
                            </div>
                        </div>
                        ${m.status !== 'completed' ? `
                            <button onclick="forceEndMatch(${m.match_id})"
                                    class="mt-3 w-full text-red-400 hover:text-red-300 text-sm py-2 border border-red-500/30 rounded-lg hover:bg-red-500/10 transition">
                                Force End Match
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading matches:', error);
            }
        }

        async function loadTournamentHistory() {
            try {
                const response = await fetch(`${API_URL}/api/admin/tournaments/history`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                const historyDiv = document.getElementById('tournament-history');
                
                if (!data.tournaments || data.tournaments.length === 0) {
                    historyDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No tournaments yet</p>';
                    return;
                }

                historyDiv.innerHTML = data.tournaments.map(t => `
                    <div class="tournament-history-item flex justify-between items-center px-4 py-3 rounded-xl">
                        <div>
                            <div class="font-semibold">${t.name}</div>
                            <div class="text-sm text-gray-500">
                                <span class="status-badge status-${t.status}">${t.status}</span>
                                <span class="ml-2">${t.players_count} players</span>
                            </div>
                        </div>
                        <button onclick="deleteSpecificTournament(${t.id}, '${t.name.replace(/'/g, "\\'")}')"
                                class="text-red-400 hover:text-red-300 text-sm px-4 py-2 border border-red-500/30 rounded-lg hover:bg-red-500/10 transition">
                            Delete
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading tournament history:', error);
            }
        }

        async function generateSchedule() {
            if (!confirm('Generate schedule? Players will no longer be able to join.')) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}/generate-schedule`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to generate schedule');

                const data = await response.json();
                alert(`Schedule generated!\n${data.rounds_created} rounds\n${data.total_matches} matches`);
                loadCurrentTournament();
            } catch (error) {
                console.error('Error generating schedule:', error);
                alert('Error generating schedule');
            }
        }

        async function nextRound() {
            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}/next-round`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to advance round');

                const data = await response.json();
                alert(`Advanced to round ${data.current_round}`);
                loadCurrentTournament();
            } catch (error) {
                console.error('Error advancing round:', error);
                alert('Error advancing round');
            }
        }

        async function forceEndMatch(matchId) {
            if (!confirm('Force end this match?')) return;

            try {
                await fetch(`${API_URL}/api/admin/match/${matchId}/force-end`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                alert('Match ended');
                loadCurrentMatches();
            } catch (error) {
                console.error('Error ending match:', error);
                alert('Error ending match');
            }
        }

        async function deleteTournament() {
            if (!currentTournament) return;

            if (!confirm(`Delete tournament "${currentTournament.name}"?\n\nThis will permanently delete all data.`)) return;
            if (!confirm('Are you SURE? This cannot be undone!')) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to delete');

                alert('Tournament deleted');
                currentTournament = null;
                document.getElementById('tournament-section').classList.add('hidden');
                loadCurrentTournament();
            } catch (error) {
                console.error('Error deleting tournament:', error);
                alert('Error deleting tournament');
            }
        }

        async function deleteSpecificTournament(tournamentId, tournamentName) {
            if (!confirm(`Delete "${tournamentName}"?`)) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${tournamentId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to delete');

                alert('Tournament deleted');
                
                if (currentTournament && currentTournament.tournament_id === tournamentId) {
                    currentTournament = null;
                    document.getElementById('tournament-section').classList.add('hidden');
                }
                
                loadTournamentHistory();
                loadCurrentTournament();
            } catch (error) {
                console.error('Error deleting tournament:', error);
                alert('Error deleting tournament');
            }
        }

        // Auto-refresh
        setInterval(() => {
            if (!document.getElementById('admin-panel').classList.contains('hidden') && currentTournament) {
                loadCurrentTournament();
            }
        }, 5000);

        // Initialize
        window.onload = () => {
            const token = localStorage.getItem('adminToken');
            if (token) {
                adminToken = token;
                showAdminPanel();
            }
        };
    </script>
</body>
</html>
