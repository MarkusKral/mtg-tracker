<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MTG Tournament</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
        <div class="max-w-md w-full">
            <h1 class="text-4xl font-bold text-center mb-8">Admin Login</h1>
            <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="admin-password"
                           class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter admin password">
                </div>
                <button onclick="adminLogin()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">
                    Login
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden">
        <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">Admin Panel</h1>
                <button onclick="logout()" class="text-red-400 hover:text-red-300">
                    Logout
                </button>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-6 py-8">
            <!-- Create Tournament -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Create New Tournament</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm mb-2">Tournament Name</label>
                        <input type="text" id="tournament-name"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                               placeholder="Friday Night Draft">
                    </div>
                    <div>
                        <label class="block text-sm mb-2">Draft Type</label>
                        <input type="text" id="draft-type"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg"
                               placeholder="Booster Draft">
                    </div>
                    <div>
                        <label class="block text-sm mb-2">Max Players</label>
                        <input type="number" id="max-players" value="8" min="2" max="20"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm mb-2">Starting Life</label>
                        <input type="number" id="starting-life" value="20" min="1"
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                    </div>
                </div>
                <button onclick="createTournament()"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-2 rounded-lg">
                    Create Tournament
                </button>
            </div>

            <!-- Current Tournament -->
            <div id="tournament-section" class="hidden">
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Current Tournament</h2>
                    <div id="tournament-info" class="space-y-2 mb-4">
                        <!-- Info will be populated -->
                    </div>

                    <div class="flex space-x-4">
                        <button id="generate-schedule-btn" onclick="generateSchedule()"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded-lg">
                            Generate Schedule
                        </button>
                        <button id="next-round-btn" onclick="nextRound()" class="hidden
                                bg-yellow-600 hover:bg-yellow-700 text-white font-bold px-6 py-2 rounded-lg">
                            Next Round
                        </button>
                        <button onclick="deleteTournament()" 
                                class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-2 rounded-lg ml-auto">
                            Delete Tournament
                        </button>
                    </div>
                </div>

                <!-- Players List -->
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Registered Players</h2>
                    <div id="players-list" class="space-y-2">
                        <!-- Players will be populated -->
                    </div>
                </div>

                <!-- Current Matches -->
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Current Matches</h2>
                    <div id="admin-matches" class="space-y-3">
                        <!-- Matches will be populated -->
                    </div>
                </div>

                <!-- Tournament History -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-bold mb-4">All Tournaments</h2>
                    <div id="tournament-history" class="space-y-2">
                        <!-- Tournament history will be populated -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let adminToken = null;
        let currentTournament = null;

        async function adminLogin() {
            const password = document.getElementById('admin-password').value;

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (!response.ok) {
                    alert('Invalid password');
                    return;
                }

                const data = await response.json();
                adminToken = data.token;
                localStorage.setItem('adminToken', adminToken);

                showAdminPanel();
            } catch (error) {
                console.error('Error logging in:', error);
                alert('Error logging in');
            }
        }

        function showAdminPanel() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadCurrentTournament();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        async function createTournament() {
            const name = document.getElementById('tournament-name').value.trim();
            const draftType = document.getElementById('draft-type').value.trim();
            const maxPlayers = parseInt(document.getElementById('max-players').value);
            const startingLife = parseInt(document.getElementById('starting-life').value);

            // Validation
            if (!name) {
                alert('Please enter a tournament name');
                return;
            }
            if (!draftType) {
                alert('Please enter a draft type');
                return;
            }
            if (maxPlayers < 2 || maxPlayers > 20) {
                alert('Max players must be between 2 and 20');
                return;
            }
            if (startingLife < 1) {
                alert('Starting life must be at least 1');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/tournament`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        name,
                        draft_type: draftType,
                        tournament_type: "Round Robin",
                        max_players: maxPlayers,
                        match_format: "Best of 1",
                        starting_life: startingLife
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Error response:', errorData);
                    throw new Error(errorData.detail || 'Failed to create tournament');
                }

                const data = await response.json();
                alert('Tournament created successfully!');
                loadCurrentTournament();
            } catch (error) {
                console.error('Error creating tournament:', error);
                alert('Error creating tournament: ' + error.message);
            }
        }

        async function loadCurrentTournament() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/current`);
                const data = await response.json();

                currentTournament = data;
                document.getElementById('tournament-section').classList.remove('hidden');

                document.getElementById('tournament-info').innerHTML = `
                    <p><strong>Name:</strong> ${data.name}</p>
                    <p><strong>Status:</strong> <span class="capitalize">${data.status}</span></p>
                    <p><strong>Players:</strong> ${data.players_count}/${data.max_players || 'N/A'}</p>
                    <p><strong>Round:</strong> ${data.current_round}/${data.total_rounds}</p>
                `;

                // Show appropriate buttons
                const generateBtn = document.getElementById('generate-schedule-btn');
                const nextRoundBtn = document.getElementById('next-round-btn');

                if (data.status === 'registration') {
                    generateBtn.classList.remove('hidden');
                    nextRoundBtn.classList.add('hidden');
                } else {
                    generateBtn.classList.add('hidden');
                    nextRoundBtn.classList.remove('hidden');
                }

                loadPlayers();
                loadCurrentMatches();
                loadTournamentHistory();
            } catch (error) {
                console.error('Error loading tournament:', error);
            }
        }

        async function loadTournamentHistory() {
            try {
                const response = await fetch(`${API_URL}/api/admin/tournaments/history`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                const historyDiv = document.getElementById('tournament-history');
                
                if (!data.tournaments || data.tournaments.length === 0) {
                    historyDiv.innerHTML = '<p class="text-gray-500">No tournaments yet</p>';
                    return;
                }

                historyDiv.innerHTML = data.tournaments.map(t => `
                    <div class="flex justify-between items-center bg-gray-700 px-4 py-3 rounded">
                        <div>
                            <div class="font-semibold">${t.name}</div>
                            <div class="text-sm text-gray-400">
                                ${t.status} • ${t.players_count} players
                                ${t.completed_at ? ' • Completed' : ''}
                            </div>
                        </div>
                        <button onclick="deleteSpecificTournament(${t.id}, '${t.name.replace(/'/g, "\\'")}')"
                                class="text-red-400 hover:text-red-300 text-sm px-3 py-1 border border-red-400 rounded hover:bg-red-900/20">
                            Delete
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading tournament history:', error);
            }
        }

        async function deleteSpecificTournament(tournamentId, tournamentName) {
            const confirmMessage = `Delete tournament "${tournamentName}"?\n\n` +
                                   `This will permanently delete all associated data.\n` +
                                   `THIS CANNOT BE UNDONE!`;

            if (!confirm(confirmMessage)) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${tournamentId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to delete tournament');
                }

                const data = await response.json();
                alert(data.message);
                
                // If we deleted the current tournament, clear it
                if (currentTournament && currentTournament.tournament_id === tournamentId) {
                    currentTournament = null;
                    document.getElementById('tournament-section').classList.add('hidden');
                }
                
                // Reload everything
                loadTournamentHistory();
                setTimeout(() => {
                    loadCurrentTournament();
                }, 500);
            } catch (error) {
                console.error('Error deleting tournament:', error);
                alert('Error deleting tournament: ' + error.message);
            }
        }

        async function loadPlayers() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${currentTournament.tournament_id}/standings`);
                const data = await response.json();

                const playersDiv = document.getElementById('players-list');
                playersDiv.innerHTML = data.standings.map(p => `
                    <div class="flex justify-between items-center bg-gray-700 px-4 py-2 rounded">
                        <span>${p.name}</span>
                        <span class="text-sm text-gray-400">${p.wins}-${p.losses}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        async function loadCurrentMatches() {
            try {
                const response = await fetch(`${API_URL}/api/tournament/${currentTournament.tournament_id}/current-round`);
                const data = await response.json();

                const matchesDiv = document.getElementById('admin-matches');

                if (!data.matches || data.matches.length === 0) {
                    matchesDiv.innerHTML = '<p class="text-gray-500">No active matches</p>';
                    return;
                }

                matchesDiv.innerHTML = data.matches.map(m => `
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold">Match ${m.match_id}</span>
                            <span class="text-sm px-2 py-1 rounded ${
                                m.status === 'completed' ? 'bg-green-600' : 'bg-yellow-600'
                            }">${m.status}</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <div>${m.player1.name} (${m.player1.health ?? 20})</div>
                            <div class="text-center text-gray-400">VS</div>
                            <div class="text-right">${m.player2.name} (${m.player2.health ?? 20})</div>
                        </div>
                        ${m.status !== 'completed' ? `
                            <button onclick="forceEndMatch(${m.match_id})"
                                    class="mt-2 text-red-400 hover:text-red-300 text-sm">
                                Force End
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading matches:', error);
            }
        }

        async function generateSchedule() {
            if (!confirm('Generate schedule? Players will no longer be able to join.')) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}/generate-schedule`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to generate schedule');

                const data = await response.json();
                alert(`Schedule generated! ${data.rounds_created} rounds, ${data.total_matches} matches`);
                loadCurrentTournament();
            } catch (error) {
                console.error('Error generating schedule:', error);
                alert('Error generating schedule');
            }
        }

        async function nextRound() {
            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}/next-round`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to advance round');

                const data = await response.json();
                alert(`Advanced to round ${data.current_round}`);
                loadCurrentTournament();
            } catch (error) {
                console.error('Error advancing round:', error);
                alert('Error advancing round');
            }
        }

        async function forceEndMatch(matchId) {
            if (!confirm('Force end this match?')) return;

            try {
                await fetch(`${API_URL}/api/admin/match/${matchId}/force-end`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                alert('Match ended');
                loadCurrentMatches();
            } catch (error) {
                console.error('Error ending match:', error);
                alert('Error ending match');
            }
        }

        async function deleteTournament() {
            if (!currentTournament) {
                alert('No tournament to delete');
                return;
            }

            const confirmMessage = `Are you sure you want to DELETE tournament "${currentTournament.name}"?\n\n` +
                                   `This will permanently delete:\n` +
                                   `- All players\n` +
                                   `- All rounds\n` +
                                   `- All matches\n` +
                                   `- All match history\n\n` +
                                   `THIS CANNOT BE UNDONE!`;

            if (!confirm(confirmMessage)) return;

            // Double confirmation
            if (!confirm('Are you ABSOLUTELY sure? This action is irreversible!')) return;

            try {
                const response = await fetch(
                    `${API_URL}/api/admin/tournament/${currentTournament.tournament_id}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to delete tournament');
                }

                const data = await response.json();
                alert(data.message);
                
                // Hide tournament section and clear current tournament
                currentTournament = null;
                document.getElementById('tournament-section').classList.add('hidden');
                
                // Try to load another tournament if one exists
                setTimeout(() => {
                    loadCurrentTournament();
                }, 500);
            } catch (error) {
                console.error('Error deleting tournament:', error);
                alert('Error deleting tournament: ' + error.message);
            }
        }

        // Auto-refresh
        setInterval(() => {
            if (!document.getElementById('admin-panel').classList.contains('hidden')) {
                loadCurrentTournament();
            }
        }, 5000);

        // Initialize
        window.onload = () => {
            const token = localStorage.getItem('adminToken');
            if (token) {
                adminToken = token;
                showAdminPanel();
            }
        };
    </script>
</body>
</html>
